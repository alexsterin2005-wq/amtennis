<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AM Tennis Academy - Book a Lesson</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .tennis-ball-spinner {
      animation: spin 1s linear infinite;
      display: inline-block;
      font-size: 3rem;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="app"></div>

  <script>
    // Initialize EmailJS
    emailjs.init("ianNIvcpna6GOLZAi");

    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBTxeuqswDst4Gh4OMvswTDaqG2llQ0ivY",
      authDomain: "am-tennis.firebaseapp.com",
      projectId: "am-tennis",
      storageBucket: "am-tennis.firebasestorage.app",
      messagingSenderId: "302418385368",
      appId: "1:302418385368:web:8b8e505efc68899cf6baad"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Firebase Firestore storage
    const storage = {
      async getAll() {
        try {
          const snapshot = await db.collection('bookings').get();
          const bookings = [];
          snapshot.forEach(doc => {
            bookings.push({ id: doc.id, ...doc.data() });
          });
          return bookings;
        } catch (error) {
          console.error('Error getting bookings:', error);
          return [];
        }
      },
      
      async add(bookingData) {
        try {
          await db.collection('bookings').doc(bookingData.id).set(bookingData);
          return true;
        } catch (error) {
          console.error('Error adding booking:', error);
          return false;
        }
      },
      
      async update(bookingId, updates) {
        try {
          await db.collection('bookings').doc(bookingId).update(updates);
          return true;
        } catch (error) {
          console.error('Error updating booking:', error);
          return false;
        }
      },
      
      async delete(bookingId) {
        try {
          await db.collection('bookings').doc(bookingId).delete();
          return true;
        } catch (error) {
          console.error('Error deleting booking:', error);
          return false;
        }
      }
    };
    
    // Generate report organized by coach
    function generateCoachReport() {
      const bookings = storage.getAll().filter(b => b.status !== 'cancelled');
      
      // Group by coach
      const byCoach = {};
      bookings.forEach(booking => {
        if (!byCoach[booking.coach]) {
          byCoach[booking.coach] = [];
        }
        byCoach[booking.coach].push(booking);
      });
      
      // Generate report text
      let report = 'AM TENNIS ACADEMY - COACH HOURS REPORT\n';
      report += '=' .repeat(60) + '\n\n';
      report += `Generated: ${new Date().toLocaleString()}\n\n`;
      
      Object.keys(byCoach).sort().forEach(coach => {
        const lessons = byCoach[coach].sort((a, b) => new Date(a.date) - new Date(b.date));
        const totalHours = lessons.reduce((sum, l) => sum + (parseInt(l.duration) / 60), 0);
        const totalRevenue = lessons.reduce((sum, l) => sum + parseFloat(l.price), 0);
        
        report += `\n${'='.repeat(60)}\n`;
        report += `COACH: ${coach}\n`;
        report += `Total Lessons: ${lessons.length}\n`;
        report += `Total Hours: ${totalHours.toFixed(2)}\n`;
        report += `Total Revenue: $${totalRevenue.toFixed(2)}\n`;
        report += `${'='.repeat(60)}\n\n`;
        
        lessons.forEach(lesson => {
          report += `Date: ${lesson.date} at ${lesson.time}\n`;
          report += `  Client: ${lesson.name}\n`;
          report += `  Duration: ${lesson.duration} minutes (${(parseInt(lesson.duration) / 60).toFixed(2)} hours)\n`;
          report += `  Price: $${lesson.price}\n`;
          report += `  Status: ${lesson.status}\n`;
          if (lesson.notes) report += `  Notes: ${lesson.notes}\n`;
          report += `\n`;
        });
      });
      
      // Calculate grand totals
      const allBookings = bookings;
      const grandTotalHours = allBookings.reduce((sum, l) => sum + (parseInt(l.duration) / 60), 0);
      const grandTotalRevenue = allBookings.reduce((sum, l) => sum + parseFloat(l.price), 0);
      
      report += `\n${'='.repeat(60)}\n`;
      report += `GRAND TOTALS\n`;
      report += `${'='.repeat(60)}\n`;
      report += `Total Lessons: ${allBookings.length}\n`;
      report += `Total Hours: ${grandTotalHours.toFixed(2)}\n`;
      report += `Total Revenue: $${grandTotalRevenue.toFixed(2)}\n`;
      
      return report;
    }
    
    // Download report as text file
    function downloadReport() {
      const report = generateCoachReport();
      const blob = new Blob([report], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tennis-coach-report-${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Coach authentication credentials
    const COACH_CREDENTIALS = {
      'alex': { password: '123', name: 'Alex' },
      'aaron': { password: '123', name: 'Aaron' },
      'mikkel': { password: '123', name: 'Mikkel' }
    };

    // Authentication functions
    function checkAuth() {
      const auth = localStorage.getItem('coach_auth');
      if (auth) {
        try {
          return JSON.parse(auth);
        } catch (e) {
          return null;
        }
      }
      return null;
    }

    function login(username, password) {
      const user = COACH_CREDENTIALS[username.toLowerCase()];
      if (user && user.password === password) {
        const authData = { username: username.toLowerCase(), name: user.name };
        localStorage.setItem('coach_auth', JSON.stringify(authData));
        return authData;
      }
      return null;
    }

    function logout() {
      localStorage.removeItem('coach_auth');
      state.isAuthenticated = false;
      state.currentCoach = null;
      state.view = 'booking';
      render();
    }

    // App State
    let state = {
      view: 'booking',
      bookings: [],
      loading: true,
      coach: 'Alex',
      date: '',
      duration: '60',
      selectedSlot: null,
      showSlots: false,
      name: '',
      email: '',
      phone: '',
      notes: '',
      message: { type: '', text: '' },
      sending: false,
      filter: 'all',
      isAuthenticated: false,
      currentCoach: null,
      loginError: '',
      weather: null,
      lastBooking: null
    };

    // Load bookings
    async function loadBookings() {
      try {
        const loadedBookings = await storage.getAll();
        state.bookings = loadedBookings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      } catch (err) {
        console.error('Error loading bookings:', err);
        state.bookings = [];
      }
      state.loading = false;
      render();
    }

    // Generate time slots
    function generateTimeSlots() {
      const slots = [];
      for (let h = 8; h <= 20; h++) {
        const suffix = h >= 12 ? 'PM' : 'AM';
        let hour12 = h % 12;
        if (hour12 === 0) hour12 = 12;
        slots.push(`${hour12}:00 ${suffix}`);
      }
      return slots;
    }

    // Generate calendar .ics file
    function generateCalendarFile(bookingData) {
      const startDate = new Date(`${bookingData.date} ${bookingData.time}`);
      const endDate = new Date(startDate.getTime() + parseInt(bookingData.duration) * 60000);
      
      const formatDate = (date) => {
        return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      };
      
      const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//AM Tennis Academy//Booking//EN',
        'BEGIN:VEVENT',
        `UID:${bookingData.id}@amtennis.netlify.app`,
        `DTSTAMP:${formatDate(new Date())}`,
        `DTSTART:${formatDate(startDate)}`,
        `DTEND:${formatDate(endDate)}`,
        `SUMMARY:Tennis Lesson with Coach ${bookingData.coach}`,
        `DESCRIPTION:Tennis lesson at AM Tennis Academy\\n\\nCoach: ${bookingData.coach}\\nDuration: ${bookingData.duration} minutes\\nPrice: $${bookingData.price}\\n\\nLocation: Council Rock North High School Tennis Courts, 62 Swamp Rd, Newtown, PA 18940`,
        'LOCATION:Council Rock North High School Tennis Courts, 62 Swamp Rd, Newtown, PA 18940',
        'STATUS:CONFIRMED',
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\\r\\n');
      
      return icsContent;
    }
    
    // Download calendar file
    function downloadCalendar(bookingData) {
      const icsContent = generateCalendarFile(bookingData);
      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tennis-lesson-${bookingData.date}.ics`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Fetch weather for selected date
    async function fetchWeather(date) {
      try {
        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=40.23&longitude=-74.99&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weather_code&temperature_unit=fahrenheit&timezone=America/New_York&start_date=${date}&end_date=${date}`);
        const data = await response.json();
        
        if (data && data.daily) {
          const weatherCode = data.daily.weather_code[0];
          const tempMax = Math.round(data.daily.temperature_2m_max[0]);
          const tempMin = Math.round(data.daily.temperature_2m_min[0]);
          const rainChance = data.daily.precipitation_probability_max[0];
          
          // Weather code to emoji/description
          let weatherEmoji = '‚òÄÔ∏è';
          let weatherDesc = 'Clear';
          if (weatherCode === 0) { weatherEmoji = '‚òÄÔ∏è'; weatherDesc = 'Clear'; }
          else if (weatherCode <= 3) { weatherEmoji = '‚õÖ'; weatherDesc = 'Partly Cloudy'; }
          else if (weatherCode <= 49) { weatherEmoji = '‚òÅÔ∏è'; weatherDesc = 'Cloudy'; }
          else if (weatherCode <= 69) { weatherEmoji = 'üåßÔ∏è'; weatherDesc = 'Rainy'; }
          else if (weatherCode <= 79) { weatherEmoji = '‚ùÑÔ∏è'; weatherDesc = 'Snow'; }
          else { weatherEmoji = '‚õàÔ∏è'; weatherDesc = 'Stormy'; }
          
          return {
            emoji: weatherEmoji,
            description: weatherDesc,
            tempMax,
            tempMin,
            rainChance
          };
        }
      } catch (error) {
        console.error('Weather fetch error:', error);
      }
      return null;
    }

    // Check if slot is booked
    function isSlotBooked(timeSlot) {
      return state.bookings.some(
        b => b.coach === state.coach && b.date === state.date && b.time === timeSlot && b.status !== 'cancelled'
      );
    }

    // Send email
    async function sendEmail(bookingData) {
      const cancellationFee = bookingData.duration === '60' ? '$15' : '$20';
      const templateParams = {
        coach: bookingData.coach,
        date: bookingData.date,
        time: bookingData.time,
        duration: bookingData.duration,
        price: bookingData.price,
        name: bookingData.name,
        email: bookingData.email,
        phone: bookingData.phone,
        notes: bookingData.notes,
        booking_id: bookingData.id,
        location: 'Council Rock North High School Tennis Courts, 62 Swamp Rd, Newtown, PA 18940',
        payment_info: 'Payment Options: Venmo: @AMTennis | Zelle: amtennis2005@gmail.com | Card | Cash/Check accepted at lesson',
        cancellation_policy: `Cancellation Policy: ${cancellationFee} cancellation fee applies if cancelled within 24 hours of the scheduled lesson time.`
      };

      try {
        // Send email to customer
        await emailjs.send('service_38t1lwl', 'template_op0e8ca', templateParams);
        
        // Send notification to business email
        const businessParams = {
          ...templateParams,
          email: 'amtennis2005@gmail.com'
        };
        await emailjs.send('service_38t1lwl', 'template_op0e8ca', businessParams);
        
        return true;
      } catch (err) {
        console.error('Email error:', err);
        return false;
      }
    }

    // Handle booking
    async function handleBooking() {
      if (!state.date || !state.selectedSlot || !state.name || !state.email) {
        state.message = { type: 'error', text: 'Please fill in all required fields and select a time slot.' };
        render();
        return;
      }

      if (isSlotBooked(state.selectedSlot)) {
        state.message = { type: 'error', text: 'This time slot is no longer available. Please select another.' };
        render();
        return;
      }

      state.sending = true;
      state.message = { type: '', text: '' };
      render();

      const price = state.duration === '60' ? 65 : 97.5;
      const bookingNumber = 1000 + state.bookings.length + 1;
      const bookingId = `#${bookingNumber}`;
      
      const bookingData = {
        id: bookingId,
        coach: state.coach,
        date: state.date,
        time: state.selectedSlot,
        duration: state.duration,
        price: price.toFixed(2),
        name: state.name,
        email: state.email,
        phone: state.phone,
        notes: state.notes,
        status: 'confirmed',
        createdAt: new Date().toISOString()
      };

      try {
        await storage.add(bookingData);
        const emailSent = await sendEmail(bookingData);
        
        state.message = {
          type: 'success',
          text: `Booking confirmed! ${state.name} with Coach ${state.coach} on ${state.date} at ${state.selectedSlot} for ${state.duration} minutes ($${price.toFixed(2)}).${emailSent ? ' Confirmation email sent.' : ' Note: Email notification failed.'}<br><br><button onclick="downloadLessonCalendar()" class="bg-green-600 text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-green-700 mt-2 inline-block">üìÖ Add to Calendar</button><br><br><strong>Payment Instructions:</strong><br>üí≥ Venmo: @AMTennis<br>üíµ Zelle: amtennis2005@gmail.com<br>üí∞ Cash/Check accepted at the lesson`
        };

        // Store booking data for calendar download
        state.lastBooking = bookingData;

        // Reset form
        state.selectedSlot = null;
        state.showSlots = false;
        state.name = '';
        state.email = '';
        state.phone = '';
        state.notes = '';
        
        await loadBookings();
      } catch (err) {
        state.message = { type: 'error', text: 'Failed to save booking. Please try again.' };
      }

      state.sending = false;
      render();
    }

    // Update booking status
    async function updateBookingStatus(bookingId, newStatus) {
      try {
        await storage.update(bookingId, { status: newStatus });
        await loadBookings();
      } catch (err) {
        console.error('Failed to update booking:', err);
      }
    }

    // Delete booking
    async function deleteBooking(bookingId) {
      if (confirm('Are you sure you want to delete this booking?')) {
        try {
          await storage.delete(bookingId);
          await loadBookings();
        } catch (err) {
          console.error('Failed to delete booking:', err);
        }
      }
    }

    // Render function
    function render() {
      const app = document.getElementById('app');
      
      if (state.loading) {
        app.innerHTML = `
          <div class="min-h-screen flex flex-col items-center justify-center">
            <div class="tennis-ball-spinner">üéæ</div>
            <div class="text-xl mt-4 text-gray-600">Loading...</div>
          </div>
        `;
        return;
      }

      const stats = {
        total: state.bookings.length,
        confirmed: state.bookings.filter(b => b.status === 'confirmed').length,
        completed: state.bookings.filter(b => b.status === 'completed').length,
        cancelled: state.bookings.filter(b => b.status === 'cancelled').length,
        revenue: state.bookings.filter(b => b.status !== 'cancelled').reduce((sum, b) => sum + parseFloat(b.price), 0)
      };

      const filteredBookings = state.bookings.filter(b => {
        if (state.filter === 'all') return true;
        return b.status === state.filter;
      });

      app.innerHTML = `
        <div class="min-h-screen">
          <!-- Header -->
          <header class="bg-black text-white py-6 px-4 shadow-lg">
            <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-4">
              <div>
                <h1 class="text-3xl font-bold">AM Tennis Academy</h1>
                <p class="text-gray-400 text-sm mt-1">Book a private lesson (Alex ‚Ä¢ Aaron ‚Ä¢ Mikkel)</p>
              </div>
              <div class="flex gap-2 flex-wrap">
                <button onclick="switchView('booking')" class="px-6 py-2 rounded-full font-semibold transition ${state.view === 'booking' ? 'bg-white text-black' : 'bg-gray-800 text-white hover:bg-gray-700'}">
                  üìÖ Book
                </button>
                <button onclick="switchView('stringing')" class="px-6 py-2 rounded-full font-semibold transition ${state.view === 'stringing' ? 'bg-white text-black' : 'bg-gray-800 text-white hover:bg-gray-700'}">
                  üéæ Stringing
                </button>
                <button onclick="switchView('contact')" class="px-6 py-2 rounded-full font-semibold transition ${state.view === 'contact' ? 'bg-white text-black' : 'bg-gray-800 text-white hover:bg-gray-700'}">
                  üìû Contact
                </button>
                ${state.isAuthenticated ? `
                  <button onclick="switchView('admin')" class="px-6 py-2 rounded-full font-semibold transition ${state.view === 'admin' ? 'bg-white text-black' : 'bg-gray-800 text-white hover:bg-gray-700'}">
                    üë• Admin
                  </button>
                  <button onclick="downloadReport()" class="px-6 py-2 rounded-full font-semibold transition bg-green-600 text-white hover:bg-green-700">
                    üìÑ Report
                  </button>
                  <button onclick="logout()" class="px-6 py-2 rounded-full font-semibold transition bg-red-600 text-white hover:bg-red-700">
                    üö™ Logout (${state.currentCoach})
                  </button>
                ` : `
                  <button onclick="switchView('login')" class="px-6 py-2 rounded-full font-semibold transition ${state.view === 'login' ? 'bg-white text-black' : 'bg-gray-800 text-white hover:bg-gray-700'}">
                    üîë Coach Login
                  </button>
                `}
              </div>
            </div>
          </header>

          <main class="py-8">
            ${state.view === 'booking' ? renderBookingView() : 
              state.view === 'stringing' ? renderStringingView() :
              state.view === 'contact' ? renderContactView() : 
              state.view === 'login' ? renderLoginView() :
              renderAdminView(stats, filteredBookings)}
          </main>
        </div>
      `;
    }

    function renderBookingView() {
      const timeSlots = generateTimeSlots();
      
      const coachInfo = {
        'Alex': {
          name: 'Alex Sterin',
          title: 'Division 1 tennis player @ Penn State',
          photo: 'https://media.licdn.com/dms/image/v2/D4E03AQHaDbeOBH_N_A/profile-displayphoto-crop_800_800/B4EZo6nxDiHMAI-/0/1761920095274?e=1767225600&v=beta&t=9IoAGCCzSVrwsmYFLauR4-zQf1gQICG-S_JZwLXMqXY'
        },
        'Aaron': {
          name: 'Aaron Sandler',
          title: 'Division 1 Tennis Player at Penn',
          photo: 'https://pennathletics.com/images/2025/9/9/Aaron_Sandler_Crooped.jpg'
        },
        'Mikkel': {
          name: 'Mikkel Zinder',
          title: 'Division 1 Tennis Player at Dayton',
          photo: 'https://i.imgur.com/4unb6ao.jpg'
        }
      };
      
      return `
        <div class="max-w-6xl mx-auto p-6">
          <!-- Meet Our Coaches Section -->
          <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <h2 class="text-3xl font-bold mb-6 text-center">Meet Our Coaches</h2>
            <div class="grid md:grid-cols-3 gap-6">
              ${Object.keys(coachInfo).map(coach => `
                <div class="text-center p-4 rounded-lg hover:bg-gray-50 transition cursor-pointer" onclick="selectCoachFromCard('${coach}')">
                  <div class="mb-4">
                    <img src="${coachInfo[coach].photo}" alt="${coachInfo[coach].name}" class="w-32 h-32 rounded-full mx-auto object-cover border-4 border-blue-500 shadow-lg">
                  </div>
                  <h3 class="text-xl font-bold mb-2">${coachInfo[coach].name}</h3>
                  <p class="text-sm text-gray-600 mb-3">üéæ ${coachInfo[coach].title}</p>
                  <button class="bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-blue-700 transition">
                    Book with ${coach}
                  </button>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Booking Form -->
          <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold mb-6 pb-3 border-b">Book a Lesson</h2>

            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div>
                <label class="block text-sm font-semibold mb-2">Choose a Coach</label>
                <select id="coach" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" onchange="updateCoachInfo()">
                  <option value="Alex" ${state.coach === 'Alex' ? 'selected' : ''}>Alex</option>
                  <option value="Aaron" ${state.coach === 'Aaron' ? 'selected' : ''}>Aaron Sandler</option>
                  <option value="Mikkel" ${state.coach === 'Mikkel' ? 'selected' : ''}>Mikkel Zinder</option>
                </select>
                <div id="coachInfo" class="mt-2 text-sm text-blue-600 font-medium">
                  üéæ ${coachInfo[state.coach].title}
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold mb-2">Lesson Length</label>
                <select id="duration" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" onchange="updatePrice()">
                  <option value="60" ${state.duration === '60' ? 'selected' : ''}>60 Minutes ($65)</option>
                  <option value="90" ${state.duration === '90' ? 'selected' : ''}>90 Minutes ($97.50)</option>
                </select>
                <div class="text-sm text-gray-600 mt-1">Rate: $65 per hour</div>
                <div id="priceDisplay" class="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                  <span class="font-semibold text-green-900">Total Price: $${state.duration === '60' ? '65.00' : '97.50'}</span>
                </div>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold mb-2">Select a Date</label>
              <input type="date" id="date" value="${state.date}" min="${new Date().toISOString().split('T')[0]}" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" onchange="updateWeather()">
              ${state.weather ? `
                <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center gap-3">
                  <div class="text-3xl">${state.weather.emoji}</div>
                  <div class="flex-1">
                    <div class="font-semibold text-blue-900">${state.weather.description}</div>
                    <div class="text-sm text-blue-700">High: ${state.weather.tempMax}¬∞F | Low: ${state.weather.tempMin}¬∞F</div>
                    <div class="text-xs text-blue-600">Rain chance: ${state.weather.rainChance}%</div>
                  </div>
                </div>
              ` : ''}
            </div>

            <button onclick="showTimes()" class="bg-blue-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-blue-700 transition mb-4">
              Show Available Times
            </button>

            ${state.showSlots ? `
              <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="font-semibold mb-3">Available times for ${state.date}:</div>
                <div class="mb-3 p-3 bg-yellow-50 border border-yellow-300 rounded-lg text-sm text-yellow-800">
                  ‚è∞ <strong>Business Hours:</strong> 8:00 AM - 8:00 PM. Slots outside these hours may require special arrangement.
                </div>
                <div class="flex flex-wrap gap-2">
                  ${timeSlots.map(slot => {
                    const booked = isSlotBooked(slot);
                    return `
                      <button 
                        onclick="${booked ? '' : `selectSlot('${slot}')`}"
                        ${booked ? 'disabled' : ''}
                        class="px-4 py-2 rounded-full text-sm font-medium transition ${
                          booked ? 'bg-gray-200 text-gray-400 cursor-not-allowed' :
                          state.selectedSlot === slot ? 'bg-blue-600 text-white' :
                          'bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50'
                        }">
                        ${slot} ${booked ? '(Booked)' : ''}
                      </button>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}

            <div class="border-t pt-6 mt-6">
              <h3 class="text-lg font-bold mb-4">Payment Information</h3>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="font-semibold text-blue-900 mb-2">üí≥ Payment Options:</div>
                <div class="space-y-1 text-sm text-blue-800">
                  <div><strong>Venmo:</strong> @AMTennis</div>
                  <div><strong>Zelle:</strong> amtennis@email.com</div>
                  <div><strong>Cash/Check:</strong> Accepted at the lesson</div>
                </div>
                <div class="mt-3 text-xs text-blue-700">
                  Payment can be made before or at the time of your lesson.
                </div>
              </div>
            </div>

            <div class="border-t pt-6 mt-6">
              <h3 class="text-lg font-bold mb-4">Your Information</h3>

              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold mb-2">Player Name *</label>
                  <input type="text" id="name" value="${state.name}" placeholder="Your name" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-2">Email *</label>
                  <input type="email" id="email" value="${state.email}" placeholder="you@example.com" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-2">Phone (optional)</label>
                  <input type="tel" id="phone" value="${state.phone}" placeholder="(xxx) xxx-xxxx" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-2">Notes (optional)</label>
                  <textarea id="notes" placeholder="Anything we should know?" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">${state.notes}</textarea>
                </div>
              </div>
            </div>

            <button onclick="bookLesson()" ${state.sending ? 'disabled' : ''} class="w-full bg-blue-600 text-white px-6 py-4 rounded-full font-bold text-lg hover:bg-blue-700 transition mt-6 disabled:bg-gray-400">
              ${state.sending ? 'Processing...' : 'Book Lesson'}
            </button>

            ${state.message.text ? `
              <div class="mt-4 p-4 rounded-lg ${state.message.type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200'}">
                ${state.message.text}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderLoginView() {
      return `
        <div class="max-w-md mx-auto p-6">
          <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-3xl font-bold mb-6 text-center">üîë Coach Login</h2>
            <p class="text-gray-600 text-center mb-6">Login to access admin panel and booking data</p>

            <form onsubmit="handleLogin(event)" class="space-y-4">
              <div>
                <label class="block text-sm font-semibold mb-2">Username</label>
                <input 
                  type="text" 
                  id="loginUsername" 
                  placeholder="alex, aaron, or mikkel" 
                  class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  required
                >
              </div>

              <div>
                <label class="block text-sm font-semibold mb-2">Password</label>
                <input 
                  type="password" 
                  id="loginPassword" 
                  placeholder="Enter your password" 
                  class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  required
                >
              </div>

              ${state.loginError ? `
                <div class="p-3 bg-red-50 text-red-800 border border-red-200 rounded-lg text-sm">
                  ‚ö†Ô∏è ${state.loginError}
                </div>
              ` : ''}

              <button 
                type="submit" 
                class="w-full bg-blue-600 text-white px-6 py-3 rounded-full font-bold text-lg hover:bg-blue-700 transition"
              >
                Login
              </button>
            </form>
          </div>
        </div>
      `;
    }

    function renderContactView() {
      return `
        <div class="max-w-4xl mx-auto p-6">
          <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-3xl font-bold mb-6 pb-3 border-b">Contact Us</h2>

            <div class="space-y-6">
              <!-- Email -->
              <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                <div class="flex items-start gap-3">
                  <div class="text-3xl">‚úâÔ∏è</div>
                  <div>
                    <h3 class="text-xl font-bold text-green-900 mb-2">Email</h3>
                    <a href="mailto:amtennis2005@gmail.com" class="text-green-700 hover:text-green-900 font-medium text-lg">
                      amtennis2005@gmail.com
                    </a>
                  </div>
                </div>
              </div>

              <!-- Phone Numbers -->
              <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                <div class="flex items-start gap-3">
                  <div class="text-3xl">üìû</div>
                  <div class="w-full">
                    <h3 class="text-xl font-bold text-purple-900 mb-3">Phone Numbers</h3>
                    <div class="space-y-2">
                      <div class="flex justify-between items-center">
                        <span class="text-purple-800 font-semibold">Alex:</span>
                        <a href="tel:+12677387290" class="text-purple-700 hover:text-purple-900 font-medium">(267) 738-7290</a>
                      </div>
                      <div class="flex justify-between items-center">
                        <span class="text-purple-800 font-semibold">Aaron Sandler:</span>
                        <a href="tel:+12675755700" class="text-purple-700 hover:text-purple-900 font-medium">(267) 575-5700</a>
                      </div>
                      <div class="flex justify-between items-center">
                        <span class="text-purple-800 font-semibold">Mikkel Zinder:</span>
                        <a href="tel:+12675755700" class="text-purple-700 hover:text-purple-900 font-medium">(267) 575-5700</a>
                      </div>
                      <div class="flex justify-between items-center">
                        <span class="text-purple-800 font-semibold">Alan Pasternak (Stringing):</span>
                        <a href="tel:+12154499148" class="text-purple-700 hover:text-purple-900 font-medium">(215) 449-9148</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Payment Info -->
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                <div class="flex items-start gap-3">
                  <div class="text-3xl">üí≥</div>
                  <div>
                    <h3 class="text-xl font-bold text-yellow-900 mb-3">Payment Options</h3>
                    <div class="space-y-1 text-yellow-800">
                      <div><strong>Venmo:</strong> @AMTennis</div>
                      <div><strong>Zelle:</strong> amtennis@email.com</div>
                      <div><strong>Cash/Check:</strong> Accepted at lessons</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Hours/Info -->
              <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                <div class="flex items-start gap-3">
                  <div class="text-3xl">‚è∞</div>
                  <div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Lesson Hours</h3>
                    <p class="text-gray-700">Available 8:00 AM - 8:00 PM</p>
                    <p class="text-gray-600 text-sm mt-2">Book your lesson online and we'll confirm your appointment!</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-8 text-center">
              <button onclick="switchView('booking')" class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold text-lg hover:bg-blue-700 transition">
                üìÖ Book a Lesson
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderStringingView() {
      return `
        <div class="max-w-6xl mx-auto p-6">
          <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-4xl font-bold mb-6 text-center">üéæ Racquet Stringing Service</h2>
            
            <!-- Stringer Profile -->
            <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-8 mb-8">
              <div class="flex flex-col md:flex-row items-center gap-6">
                <div class="flex-shrink-0">
                  <div class="w-48 h-48 rounded-full bg-gray-200 flex items-center justify-center text-6xl border-4 border-blue-500 shadow-lg">
                    üéæ
                  </div>
                  <p class="text-center text-gray-500 text-sm mt-2">Photo coming soon</p>
                </div>
                <div class="flex-1 text-center md:text-left">
                  <h3 class="text-3xl font-bold mb-2">Alan Pasternak</h3>
                  <p class="text-xl text-gray-700 mb-4">Professional Racquet Stringer</p>
                  <div class="bg-white rounded-lg p-4 inline-block">
                    <div class="flex items-center gap-2 text-lg">
                      <span class="text-2xl">‚≠ê</span>
                      <span class="font-semibold">3 Years Experience</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pricing -->
            <div class="mb-8">
              <h3 class="text-2xl font-bold mb-6 text-center">Pricing</h3>
              <div class="grid md:grid-cols-2 gap-6">
                <!-- With String -->
                <div class="bg-green-50 border-2 border-green-500 rounded-xl p-6 hover:shadow-lg transition">
                  <div class="text-center">
                    <div class="text-5xl mb-4">‚úÖ</div>
                    <h4 class="text-2xl font-bold mb-2">With String</h4>
                    <div class="text-5xl font-bold text-green-600 mb-2">$15</div>
                    <p class="text-gray-600">You provide the string</p>
                  </div>
                </div>
                
                <!-- Without String -->
                <div class="bg-blue-50 border-2 border-blue-500 rounded-xl p-6 hover:shadow-lg transition">
                  <div class="text-center">
                    <div class="text-5xl mb-4">üéÅ</div>
                    <h4 class="text-2xl font-bold mb-2">Without String</h4>
                    <div class="text-5xl font-bold text-blue-600 mb-2">$25</div>
                    <p class="text-gray-600">String provided by us</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Service Info -->
            <div class="bg-gray-50 rounded-xl p-6 mb-8">
              <h3 class="text-xl font-bold mb-4 text-center">Service Details</h3>
              <div class="grid md:grid-cols-3 gap-4 text-center">
                <div>
                  <div class="text-3xl mb-2">‚ö°</div>
                  <div class="font-semibold">Quick Turnaround</div>
                  <div class="text-sm text-gray-600">Usually 24-48 hours</div>
                </div>
                <div>
                  <div class="text-3xl mb-2">üéØ</div>
                  <div class="font-semibold">Professional Quality</div>
                  <div class="text-sm text-gray-600">3 years of experience</div>
                </div>
                <div>
                  <div class="text-3xl mb-2">üìç</div>
                  <div class="font-semibold">Convenient Location</div>
                  <div class="text-sm text-gray-600">Newtown, PA</div>
                </div>
              </div>
            </div>

            <!-- Contact for Stringing -->
            <div class="text-center bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl p-8">
              <h3 class="text-2xl font-bold mb-4">Ready to Get Your Racquet Strung?</h3>
              <p class="text-lg mb-6">Contact us to schedule your stringing service</p>
              <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="tel:+12154499148" class="bg-white text-blue-600 px-8 py-3 rounded-full font-bold text-lg hover:bg-gray-100 transition inline-block">
                  üìû Call Alan: (215) 449-9148
                </a>
                <a href="mailto:amtennis2005@gmail.com" class="bg-white text-purple-600 px-8 py-3 rounded-full font-bold text-lg hover:bg-gray-100 transition inline-block">
                  ‚úâÔ∏è Email Us
                </a>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderAdminView(stats, filteredBookings) {
      return `
        <div class="max-w-7xl mx-auto p-6">
          <h1 class="text-3xl font-bold mb-8">Admin Dashboard</h1>

          <!-- Stats -->
          <div class="grid md:grid-cols-5 gap-4 mb-8">
            <div class="bg-white p-6 rounded-xl shadow">
              <div class="text-gray-500 text-sm">Total Bookings</div>
              <div class="text-3xl font-bold">${stats.total}</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow">
              <div class="text-gray-500 text-sm">Confirmed</div>
              <div class="text-3xl font-bold text-green-600">${stats.confirmed}</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow">
              <div class="text-gray-500 text-sm">Completed</div>
              <div class="text-3xl font-bold text-blue-600">${stats.completed}</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow">
              <div class="text-gray-500 text-sm">Cancelled</div>
              <div class="text-3xl font-bold text-red-600">${stats.cancelled}</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow">
              <div class="text-gray-500 text-sm">Revenue</div>
              <div class="text-3xl font-bold text-green-600">$${stats.revenue.toFixed(0)}</div>
            </div>
          </div>

          <!-- Filters -->
          <div class="bg-white p-4 rounded-xl shadow mb-6">
            <div class="flex gap-2 flex-wrap">
              ${['all', 'confirmed', 'completed', 'cancelled'].map(f => `
                <button onclick="setFilter('${f}')" class="px-4 py-2 rounded-full font-medium capitalize transition ${state.filter === f ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                  ${f}
                </button>
              `).join('')}
            </div>
          </div>

          <!-- Table -->
          <div class="bg-white rounded-xl shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Date & Time</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Coach</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Client</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Contact</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Duration</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Price</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  ${filteredBookings.map(booking => `
                    <tr class="hover:bg-gray-50">
                      <td class="px-6 py-4">
                        <div class="font-medium">${booking.date}</div>
                        <div class="text-sm text-gray-500">${booking.time}</div>
                      </td>
                      <td class="px-6 py-4 font-medium">${booking.coach}</td>
                      <td class="px-6 py-4">
                        <div class="font-medium">${booking.name}</div>
                        ${booking.notes ? `<div class="text-xs text-gray-500 mt-1">${booking.notes}</div>` : ''}
                      </td>
                      <td class="px-6 py-4">
                        <div class="text-sm">${booking.email}</div>
                        ${booking.phone ? `<div class="text-sm text-gray-500">${booking.phone}</div>` : ''}
                      </td>
                      <td class="px-6 py-4">${booking.duration} min</td>
                      <td class="px-6 py-4 font-semibold">$${booking.price}</td>
                      <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                          booking.status === 'confirmed' ? 'bg-green-100 text-green-800' :
                          booking.status === 'completed' ? 'bg-blue-100 text-blue-800' :
                          'bg-red-100 text-red-800'
                        }">
                          ${booking.status}
                        </span>
                      </td>
                      <td class="px-6 py-4">
                        <select onchange="updateStatus('${booking.id}', this.value)" class="text-sm border rounded px-2 py-1 mr-2">
                          <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                          <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                          <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                        <button onclick="deleteBookingAction('${booking.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                          Delete
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${filteredBookings.length === 0 ? '<div class="text-center py-12 text-gray-500">No bookings found for this filter.</div>' : ''}
          </div>
        </div>
      `;
    }

    // Event handlers
    window.switchView = (view) => {
      state.view = view;
      render();
    };

    window.showTimes = () => {
      state.coach = document.getElementById('coach').value;
      state.duration = document.getElementById('duration').value;
      state.date = document.getElementById('date').value;
      
      if (!state.date) {
        state.message = { type: 'error', text: 'Please select a date first.' };
        render();
        return;
      }
      
      state.showSlots = true;
      state.selectedSlot = null;
      state.message = { type: '', text: '' };
      render();
      
      // Auto-scroll to time slots
      setTimeout(() => {
        const slotsContainer = document.querySelector('.bg-gray-50.rounded-lg');
        if (slotsContainer) {
          slotsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 100);
    };

    window.selectSlot = (slot) => {
      state.selectedSlot = slot;
      render();
    };

    window.selectCoachFromCard = (coach) => {
      state.coach = coach;
      // Scroll to booking form
      setTimeout(() => {
        const bookingForm = document.querySelector('.max-w-6xl > .bg-white:last-child');
        if (bookingForm) {
          bookingForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
      render();
    };

    window.updateWeather = async () => {
      const date = document.getElementById('date').value;
      if (date) {
        state.date = date;
        state.weather = await fetchWeather(date);
        render();
      }
    };
    
    window.downloadLessonCalendar = () => {
      if (state.lastBooking) {
        downloadCalendar(state.lastBooking);
      }
    };

    window.bookLesson = () => {
      state.coach = document.getElementById('coach').value;
      state.duration = document.getElementById('duration').value;
      state.date = document.getElementById('date').value;
      state.name = document.getElementById('name').value;
      state.email = document.getElementById('email').value;
      state.phone = document.getElementById('phone').value;
      state.notes = document.getElementById('notes').value;
      handleBooking();
    };

    window.setFilter = (filter) => {
      state.filter = filter;
      render();
    };

    window.updateStatus = (bookingId, newStatus) => {
      updateBookingStatus(bookingId, newStatus);
    };

    window.deleteBookingAction = (bookingId) => {
      deleteBooking(bookingId);
    };

    window.updateCoachInfo = () => {
      const coach = document.getElementById('coach').value;
      const coachInfo = {
        'Alex': 'Division 1 tennis player @ Penn State',
        'Aaron': 'Aaron Sandler - Division 1 Tennis Player at Penn',
        'Mikkel': 'Mikkel Zinder - Division 1 Tennis Player at Dayton'
      };
      const infoElement = document.getElementById('coachInfo');
      if (infoElement) {
        infoElement.textContent = 'üéæ ' + coachInfo[coach];
      }
    };

    window.updatePrice = () => {
      const duration = document.getElementById('duration').value;
      const price = duration === '60' ? '65.00' : '97.50';
      const priceDisplay = document.getElementById('priceDisplay');
      if (priceDisplay) {
        priceDisplay.innerHTML = `<span class="font-semibold text-green-900">Total Price: $${price}</span>`;
      }
    };

    window.handleLogin = (event) => {
      event.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      const auth = login(username, password);
      if (auth) {
        state.isAuthenticated = true;
        state.currentCoach = auth.name;
        state.loginError = '';
        state.view = 'admin';
        render();
      } else {
        state.loginError = 'Invalid username or password';
        render();
      }
    };

    // Initialize
    const auth = checkAuth();
    if (auth) {
      state.isAuthenticated = true;
      state.currentCoach = auth.name;
    }
    loadBookings();
  </script>
</body>
</html>